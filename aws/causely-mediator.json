{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "CloudFormation template to create the ECS Service for the Causely Mediator.",
    "Parameters": {
        "CreateIAMRoles": {
            "Type": "String",
            "Default": "False",
            "AllowedValues": [
                "True",
                "False"
            ],
            "Description": "Whether to create default IAM roles",
            "ConstraintDescription": "must specify True or False."
        },
        "ExecutionRoleArn": {
            "Type": "String",
            "Default": "arn:aws:iam::040365544943:role/ecsTaskExecutionRole",
            "Description": "Enter the role arn you want to use as the ecs execution role"
        },
        "ECSClusterName": {
            "Type": "String",
            "Default": "chaos"
        },
        "ECSServiceName": {
            "Type": "String",
            "Default": "causely"
        },
        "SecurityGroupIDs": {
            "Type": "CommaDelimitedList",
            "Default": "sg-0ca2fc2bdfa907816"
        },
        "SubnetIDs": {
            "Type": "CommaDelimitedList",
            "Default": "subnet-0ec3f08a1f28407d8,subnet-081ec67fcb58c84d8,subnet-09fa95e81730c8202"
        },
        "VpcID": {
            "Type": "String",
            "Default": "vpc-0aa141fb0f6ddb9aa"
        },
        "CauselyGatewayToken": {
            "Type": "String",
            "Description": "The Causely Gateway Token for authentication",
            "NoEcho": true
        }
    },
    "Conditions": {
        "CreateRoles": {
            "Fn::Equals": [
                {
                    "Ref": "CreateIAMRoles"
                },
                "True"
            ]
        },
        "DefaultExecutionRole": {
            "Fn::Equals": [
                {
                    "Ref": "ExecutionRoleArn"
                },
                "Default"
            ]
        }
    },
    "Resources": {
        "ECSTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "Family": "causely",
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": ["FARGATE"],
                "Cpu": "2048",
                "Memory": "8192",
                "ExecutionRoleArn": {
                    "Ref": "ExecutionRoleArn"
                },
                "ContainerDefinitions": [
                    {
                        "Name": "mediator",
                        "Image": "us-docker.pkg.dev/public-causely/public/mediator",
                        "Essential": true,
                        "Command": [
                            "/bin/sh",
                            "-c",
                            {
                              "Fn::Join": [
                                "\n",
                                [
                                  "cat > /tmp/config.yaml << 'EOF'",
                                  "gateway:",
                                  "  host: gw.causely.app",
                                  "  port: 443",
                                  "  tls: true",
                                  "  insecure: false",
                                  "ml:",
                                  "  enabled: true",
                                  "  host: ml",
                                  "  port: 50052",
                                  "  token: \"\"",
                                  "  tls: false",
                                  "  insecure: true",
                                  "repository:",
                                  "    backend_sync:",
                                  "      interval: 30s",
                                  "    entity_attribute_metrics:",
                                  "      enabled: true",
                                  "    garbage_collector:",
                                  "      enabled: true",
                                  "      interval: 5m",
                                  "    persistence:",
                                  "      enabled: true",
                                  "      interval: 60s",
                                  "      path: /data/mediator.gob",
                                  "      storage: 10Gi",
                                  "    timeseries_forecast:",
                                  "      enabled: true",
                                  "      interval: 1h",
                                  "global:",
                                  "  host_root: /",
                                  {
                                    "Fn::Sub": "  cluster_name: ${ECSClusterName}"
                                  },
                                  "server:",
                                  "  listen_port: 50051",
                                  "webserver:",
                                  "  port: 8082",
                                  "time_series:",
                                  "  hostname: victoriametrics",
                                  "  port: 8428",
                                  "scrapers:",
                                  "  - type: AWS",
                                  "    enabled: true",
                                  "    sync_interval: 60s",
                                  "    logging:",
                                  "      scraper:",
                                  "        level: info",
                                  "      repository:",
                                  "        level: info",
                                  "  - type: Dynatrace",
                                  "    enabled: true",
                                  "    sync_interval: 60s",
                                  "    logging:",
                                  "      scraper:",
                                  "        level: info",
                                  "      repository:",
                                  "        level: info",
                                  "  - type: CauselyServices",
                                  "    enabled: true",
                                  "    sync_interval: 15m",
                                  "    logging:",
                                  "      scraper:",
                                  "        level: info",
                                  "      repository:",
                                  "        level: info",
                                  "EOF",
                                  "/bin/mediator -config /tmp/config.yaml"
                                ]
                              ]
                            }
                        ],
                        "PortMappings": [
                        {
                          "ContainerPort": 4317,
                          "HostPort": 4317,
                          "Protocol": "tcp"
                        },
                        {
                          "ContainerPort": 8125,
                          "HostPort": 8125,
                          "Protocol": "tcp"
                        },
                        {
                          "ContainerPort": 50051,
                          "Protocol": "tcp"
                        },
                        {
                          "ContainerPort": 8082,
                          "Protocol": "tcp"
                        }
                      ],
                        "Environment": [
                            { "Name": "CAUSELY_GATEWAY_TOKEN", "Value": { "Ref": "CauselyGatewayToken" } }
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": "/ecs/causely",
                                "awslogs-region": "us-east-2",
                                "awslogs-stream-prefix": "mediator",
                                "awslogs-create-group": "True"
                            }
                        },
                        "HealthCheck": {
                            "Command": [
                                "CMD-SHELL",
                                "curl -f http://localhost:8082/health || exit 1"
                            ],
                            "StartPeriod": 60
                        },
                        "MountPoints": [
                            {
                                "ContainerPath": "/data",
                                "SourceVolume": "mediator"
                            }
                        ]
                    },
                    {
                      "Name": "ml",
                      "Image": "us-docker.pkg.dev/public-causely/public/ml",
                      "Essential": false,
                      "Command": [
                        "/bin/sh",
                        "-c",
                        {
                          "Fn::Join": [
                            "\n",
                            [
                              "cat > /tmp/config.yaml << 'EOF'",
                              "grpc:",
                              "  host: 0.0.0.0",
                              "  max_receive_msg_size: 33554432",
                              "  max_send_msg_size: 33554432",
                              "  port: 50052",
                              "model:",
                              "  freq: 5min",
                              "  horizon: 12",
                              "  iqr:",
                              "    lower_quantile: 0",
                              "    upper_quantile: 0.95",
                              "    window_size: 72",
                              "  min_threshold_ms: 10",
                              "victoriametrics:",
                              "  backoff_multiplier: 2",
                              "  batch_size: 100",
                              "  batch_write_size: 1000",
                              "  endpoint: http://victoriametrics:8428",
                              "  initial_backoff_seconds: 1",
                              "  jitter: 0.1",
                              "  max_backoff_minutes: 20",
                              "  period: 24h",
                              "  step: 5m",
                              "webserver:",
                              "  host: 0.0.0.0",
                              "  port: 8081",
                              "EOF",
                              "uv run mediator/main.py --config /tmp/config.yaml"
                            ]
                          ]
                        }
                      ],
                      "LogConfiguration": {
                        "LogDriver": "awslogs",
                        "Options": {
                          "awslogs-group": "/ecs/causely",
                          "awslogs-region": "us-east-2",
                          "awslogs-stream-prefix": "ml",
                          "awslogs-create-group": "True"
                        }
                      },
                      "HealthCheck": {
                        "Command": [
                          "CMD-SHELL",
                          "curl -f http://localhost:8081/health || exit 1"
                        ],
                        "StartPeriod": 60
                      },
                      "PortMappings": [
                        {
                          "ContainerPort": 50052,
                          "Protocol": "tcp"
                        },
                        {
                          "ContainerPort": 8081,
                          "Protocol": "tcp"
                        }
                      ]
                    },
                    {
                      "Name": "victoriametrics",
                      "Image": "victoriametrics/victoria-metrics:v1.128.0",
                      "Essential": false,
                      "Command": [
                        "-search.maxConcurrentRequests=128",
                        "-search.maxUniqueTimeseries=3000000",
                        "-search.maxQueryDuration=5m",
                        "-search.maxQueryLen=65536",
                        "-retentionPeriod=1d"
                      ],
                      "LogConfiguration": {
                        "LogDriver": "awslogs",
                        "Options": {
                          "awslogs-group": "/ecs/causely",
                          "awslogs-region": "us-east-2",
                          "awslogs-stream-prefix": "victoriametrics",
                          "awslogs-create-group": "True"
                        }
                      },
                      "MountPoints": [
                        {
                          "ContainerPath": "/victoria-metrics-data",
                          "SourceVolume": "victoriametrics"
                        }
                      ],
                      "PortMappings": [
                        {
                          "ContainerPort": 8428,
                          "Protocol": "tcp"
                        }
                      ]
                    }
                ],
                "Volumes": [
                  {
                    "Name": "mediator",
                    "Host": {}
                  },
                  {
                    "Name": "victoriametrics",
                    "Host": {}
                  }
                ],
                "Tags": [
                    { "Key": "app", "Value": "causely" }
                ]
            }
        },
        "ECSService": {
            "Type": "AWS::ECS::Service",
            "Properties": {
                "Cluster": {
                    "Ref": "ECSClusterName"
                },
                "CapacityProviderStrategy": [
                    {
                        "CapacityProvider": "FARGATE",
                        "Base": 0,
                        "Weight": 1
                    }
                ],
                "TaskDefinition": {
                    "Ref": "ECSTaskDefinition"
                },
                "ServiceName": {
                    "Ref": "ECSServiceName"
                },
                "SchedulingStrategy": "REPLICA",
                "DesiredCount": 1,
                "AvailabilityZoneRebalancing": "ENABLED",
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "ENABLED",
                        "SecurityGroups": {
                            "Ref": "SecurityGroupIDs"
                        },
                        "Subnets": {
                            "Ref": "SubnetIDs"
                        }
                    }
                },
                "PlatformVersion": "LATEST",
                "DeploymentConfiguration": {
                    "DeploymentCircuitBreaker": {
                        "Enable": true,
                        "Rollback": true
                    },
                    "Strategy": "ROLLING",
                    "MaximumPercent": 200
                },
                "DeploymentController": {
                    "Type": "ECS"
                },
                "Tags": [
                    { "Key": "app", "Value": "causely-mediator" }
                ],
                "EnableECSManagedTags": true,
                "EnableExecuteCommand": false
            },
            "DependsOn": [
                "ECSTaskDefinition"
            ]
        },
        "ECSExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateRoles",
            "Properties": {
                "Description": "Allows ECS container agent makes calls to the Amazon ECS API on your behalf.",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy",
                    "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess",
                    "arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess"
                ],
                "RoleName": "CauselyExecutionRole"
            }
        }
    },
    "Outputs": {
        "ClusterName": {
            "Description": "The cluster used to create the service.",
            "Value": {
                "Ref": "ECSClusterName"
            }
        },
        "ECSService": {
            "Description": "The created service.",
            "Value": {
                "Ref": "ECSService"
            }
        }
    }
}
